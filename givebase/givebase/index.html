<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Umanity - Help People in Need</title>

    <!-- Farcaster Mini App Meta Tags -->
    <meta name="fc:miniapp"
        content='{"version":"1","imageUrl":"https://miniapp.umanity.xyz/icon.png","button":{"title":"💙 Help People","action":{"type":"launch_miniapp","url":"https://miniapp.umanity.xyz","name":"Umanity","splashImageUrl":"https://miniapp.umanity.xyz/icon.png","splashBackgroundColor":"#ffffff"}}}' />

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gray-50': '#fafafa',
                        'gray-100': '#f5f5f5',
                        'gray-200': '#e5e5e5',
                        'gray-300': '#d4d4d4',
                        'gray-400': '#a3a3a3',
                        'gray-500': '#737373',
                        'gray-600': '#525252',
                        'gray-700': '#404040',
                        'gray-800': '#262626',
                        'gray-900': '#171717',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        * {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
        }

        /* Premium Cards */
        .help-card {
            background: linear-gradient(145deg, #ffffff 0%, #fafafa 100%);
            border: 1px solid rgba(0, 0, 0, 0.08);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
        }

        .help-card:active {
            transform: scale(0.98);
        }

        /* Buttons */
        .primary-button {
            background: linear-gradient(135deg, #000000 0%, #262626 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .primary-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .primary-button:active {
            transform: scale(0.97);
        }

        .secondary-button {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .secondary-button:active {
            transform: scale(0.97);
        }

        /* Progress Bars */
        .progress-bar {
            background: linear-gradient(90deg, #000000, #404040);
            transition: width 0.8s ease;
        }

        /* Modal Styling */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
        }

        /* Form Inputs */
        .form-input {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
            outline: none;
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid #000000;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Urgency Indicators */
        .urgency-high {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            animation: pulse 2s infinite;
        }

        .urgency-medium {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
        }

        .urgency-low {
            background: linear-gradient(135deg, #059669, #10b981);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }
        }

        /* Slide up animation */
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .slide-up {
            animation: slideUp 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Tab indicator */
        .tab-indicator {
            position: absolute;
            bottom: 0;
            height: 3px;
            background: #000;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Swipe hint */
        @keyframes swipeHint {
            0% {
                transform: translateX(0);
            }

            50% {
                transform: translateX(-10px);
            }

            100% {
                transform: translateX(0);
            }
        }

        .swipe-hint {
            animation: swipeHint 2s ease-in-out infinite;
        }

        /* Quick donate button active */
        .quick-donate-btn {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .quick-donate-btn:active {
            transform: scale(0.95);
        }

        .quick-donate-btn.selected {
            background: linear-gradient(135deg, #000000 0%, #262626 100%);
            color: white;
            border-color: transparent;
        }

        /* Stats card gradient */
        .stats-gradient {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.03) 0%, rgba(0, 0, 0, 0.01) 100%);
        }

        /* Floating action button */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: linear-gradient(135deg, #000000 0%, #262626 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 40;
            transition: all 0.3s ease;
        }

        .fab:active {
            transform: scale(0.9);
        }

        /* Bottom sheet animation */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 24px 24px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 50;
            max-height: 90vh;
            overflow-y: auto;
        }

        .bottom-sheet.open {
            transform: translateY(0);
        }

        /* Pull to refresh */
        .pull-to-refresh {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            transition: all 0.3s ease;
        }

        .pull-to-refresh.active {
            top: 10px;
        }

        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Hide scrollbar but keep functionality */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Safe area padding for mobile */
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>

<body class="bg-white text-gray-900">
    <div id="app"></div>

    <script type="module">
        import { sdk } from '@farcaster/miniapp-sdk'

        // Create the main app HTML structure
        document.getElementById('app').innerHTML = `
            <!-- Splash Screen -->
            <div id="splashScreen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
                <div class="text-center">
                    <div class="text-6xl mb-4">💙</div>
                    <h1 class="text-3xl font-black mb-2">Umanity</h1>
                    <p class="text-gray-600">Loading your dashboard...</p>
                    <div class="loading-spinner mx-auto mt-6"></div>
                </div>
            </div>

            <!-- Main App Content -->
            <div id="mainContent" class="hidden min-h-screen bg-white">
                <!-- Pull to Refresh Indicator -->
                <div class="pull-to-refresh" id="pullToRefresh">
                    <div class="loading-spinner w-8 h-8"></div>
                </div>

                <!-- Header -->
                <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-xl border-b border-gray-100">
                    <div class="px-4 py-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <h1 class="text-2xl font-black">Umanity</h1>
                                <span class="text-xs bg-black text-white px-2 py-1 rounded-full font-medium">Beta</span>
                            </div>
                            <button id="walletButton" class="secondary-button px-4 py-2 rounded-full text-sm font-medium flex items-center space-x-2">
                                <i class="fas fa-wallet"></i>
                                <span>Connect</span>
                            </button>
                        </div>
                    </div>
                </header>

                <!-- Tab Navigation -->
                <div class="sticky top-[61px] z-30 bg-white border-b border-gray-100">
                    <div class="relative">
                        <div class="flex overflow-x-auto hide-scrollbar px-2 py-2">
                            <button class="tab-btn active px-3 py-2 text-xs font-semibold whitespace-nowrap flex-shrink-0" data-tab="donate">
                                💙 Donate
                            </button>
                            <button class="tab-btn px-3 py-2 text-xs font-semibold whitespace-nowrap text-gray-500 flex-shrink-0" data-tab="pools">
                                🌊 Pools
                            </button>
                            <button class="tab-btn px-3 py-2 text-xs font-semibold whitespace-nowrap text-gray-500 flex-shrink-0" data-tab="social">
                                👥 Social
                            </button>
                            <button class="tab-btn px-3 py-2 text-xs font-semibold whitespace-nowrap text-gray-500 flex-shrink-0" data-tab="leaderboard">
                                🏆 Top
                            </button>
                            <button class="tab-btn px-3 py-2 text-xs font-semibold whitespace-nowrap text-gray-500 flex-shrink-0" data-tab="profile">
                                ⭐ Profile
                            </button>
                        </div>
                        <div class="tab-indicator" id="tabIndicator"></div>
                    </div>
                </div>

                <!-- Main Content Area -->

                <!-- Epoch Banner -->
                <div class="px-4 py-3 bg-gradient-to-r from-purple-50 via-blue-50 to-green-50 border-b border-gray-100">
                    <div class="text-center">
                        <div class="flex items-center justify-center space-x-4 text-xs">
                            <div class="flex items-center space-x-1">
                                <span class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></span>
                                <span class="font-bold text-purple-600">EPOCH 0</span>
                            </div>
                            <div class="text-gray-600">|</div>
                            <div class="text-blue-600 font-medium">
                                🎁 <span id="pointsMultiplier">10x</span> Points
                            </div>
                            <div class="text-gray-600">|</div>
                            <div class="text-green-600 font-medium">
                                🚀 <span id="tokensMultiplier">5000x</span> Tokens
                            </div>
                        </div>
                        <div class="text-xs text-gray-600 mt-1">
                            Genesis rewards! Earn massive bonuses for early adoption
                        </div>
                    </div>
                </div>
                <main class="pb-20 safe-area-bottom">
                    <!-- Donate Tab -->
                    <div id="donateTab" class="tab-content">
                        <!-- Stats Cards -->
                    <div class="px-4 py-4">
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="help-card rounded-2xl p-4 stats-gradient">
                                <div class="text-2xl font-black" id="totalRaised">$0</div>
                                <div class="text-xs text-gray-600 mt-1">Total Raised</div>
                            </div>
                            <div class="help-card rounded-2xl p-4 stats-gradient">
                                <div class="text-2xl font-black" id="peopleHelped">0</div>
                                <div class="text-xs text-gray-600 mt-1">People Helped</div>
                            </div>
                        </div>
                        
                        <!-- User Rewards Display (if connected) -->
                        <div id="userRewardsCard" class="hidden">
                            <div class="help-card rounded-2xl p-4 bg-gradient-to-r from-purple-50 to-blue-50">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="text-center">
                                        <div class="text-lg font-black text-purple-600" id="userPointsDisplay">0</div>
                                        <div class="text-xs text-purple-500">Points Earned</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-black text-blue-600" id="userTokensDisplay">0 $GIVE</div>
                                        <div class="text-xs text-blue-500">Tokens Earned</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                        <!-- Filter Pills -->
                        <div class="px-4 pb-4">
                            <div class="flex space-x-2 overflow-x-auto hide-scrollbar">
                                <button class="filter-pill active px-4 py-2 rounded-full bg-black text-white text-sm font-medium whitespace-nowrap" data-filter="all">
                                    All
                                </button>
                                <button class="filter-pill px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm font-medium whitespace-nowrap" data-filter="medical">
                                    🏥 Medical
                                </button>
                                <button class="filter-pill px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm font-medium whitespace-nowrap" data-filter="emergency">
                                    🚨 Emergency
                                </button>
                                <button class="filter-pill px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm font-medium whitespace-nowrap" data-filter="education">
                                    🎓 Education
                                </button>
                                <button class="filter-pill px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm font-medium whitespace-nowrap" data-filter="community">
                                    🏘️ Community
                                </button>
                            </div>
                        </div>

                        <!-- Recipients List -->
                        <div id="recipientsList" class="px-4 space-y-4">
                            <!-- Loading skeleton -->
                            <div class="help-card rounded-3xl p-4">
                                <div class="skeleton h-20 rounded-xl mb-3"></div>
                                <div class="skeleton h-4 w-3/4 rounded mb-2"></div>
                                <div class="skeleton h-4 w-1/2 rounded"></div>
                            </div>
                        </div>

                        <!-- Load More -->
                        <div id="loadMoreContainer" class="px-4 py-6 hidden">
                            <button id="loadMoreBtn" class="w-full py-3 bg-gray-100 rounded-2xl font-medium text-gray-700">
                                Load More
                            </button>
                        </div>
                    </div>

                    <!-- Pools Tab -->
                    <div id="poolsTab" class="tab-content hidden">
                        <div class="px-4 py-4">
                            <div class="mb-6">
                                <h2 class="text-xl font-bold mb-2">Global Impact Pools</h2>
                                <p class="text-sm text-gray-600">Support causes that matter to you</p>
                            </div>
                            <div id="poolsList" class="space-y-4">
                                <!-- Loading skeleton -->
                                <div class="help-card rounded-3xl p-4">
                                    <div class="skeleton h-16 rounded-xl"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Social Tab -->
                    <div id="socialTab" class="tab-content hidden">
                        <div class="px-4 py-4">
                            <!-- Social Stats -->
                            <div class="grid grid-cols-3 gap-3 mb-6">
                                <div class="text-center">
                                    <div class="text-2xl font-black" id="socialDonations">0</div>
                                    <div class="text-xs text-gray-600">Donations</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-black" id="socialImpact">$0</div>
                                    <div class="text-xs text-gray-600">Impact</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-black" id="socialRank">#-</div>
                                    <div class="text-xs text-gray-600">Rank</div>
                                </div>
                            </div>

                            <!-- Quick Send -->
                            <div class="help-card rounded-3xl p-4 mb-6">
                                <h3 class="font-bold mb-3">Quick Send</h3>
                                <div class="flex items-center space-x-3">
                                    <input type="text" id="recipientUsername" placeholder="@username or address" class="form-input flex-1 px-4 py-3 rounded-xl text-sm">
                                    <button id="quickSendBtn" class="primary-button px-6 py-3 rounded-xl text-white font-medium">
                                        Send
                                    </button>
                                </div>
                            </div>

                            <!-- Social Feed -->
                            <div class="mb-4">
                                <h3 class="font-bold mb-3">Recent Activity</h3>
                                <div id="socialFeed" class="space-y-3">
                                    <!-- Loading skeleton -->
                                    <div class="help-card rounded-2xl p-3">
                                        <div class="skeleton h-12 rounded"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Leaderboard Tab -->
                    <div id="leaderboardTab" class="tab-content hidden">
                        <div class="px-4 py-4">
                            <div class="mb-6">
                                <h2 class="text-xl font-bold mb-2">🏆 Top Donors</h2>
                                <p class="text-sm text-gray-600">Champions of generosity</p>
                            </div>
                            
                            <!-- User Position (if not in top 10) -->
                            <div id="userPositionCard" class="hidden mb-4">
                                <div class="help-card rounded-2xl p-4 bg-gradient-to-r from-purple-50 to-blue-50">
                                    <div class="text-xs text-gray-600 mb-2 text-center">Your Position</div>
                                    <div id="userPositionInfo" class="flex items-center justify-between">
                                        <!-- Populated dynamically -->
                                    </div>
                                </div>
                            </div>

                            <div id="leaderboardList" class="space-y-3">
                                <!-- Loading skeleton -->
                                <div class="help-card rounded-2xl p-4">
                                    <div class="skeleton h-12 rounded"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Tab -->
                    <div id="profileTab" class="tab-content hidden">
                        <div class="px-4 py-4">
                            <!-- Profile Header -->
                            <div class="text-center mb-6">
                                <div class="w-24 h-24 bg-gradient-to-r from-black to-gray-700 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-3xl font-bold" id="profileAvatar">
                                    ?
                                </div>
                                <h2 class="text-xl font-bold" id="profileName">Connect Wallet</h2>
                                <p class="text-sm text-gray-600" id="profileAddress">-</p>
                            </div>

                            <!-- Profile Stats -->
                            <div class="grid grid-cols-2 gap-3 mb-6">
                                <div class="help-card rounded-2xl p-4 text-center">
                                    <div class="text-2xl font-black" id="userDonated">$0</div>
                                    <div class="text-xs text-gray-600">Total Donated</div>
                                </div>
                                <div class="help-card rounded-2xl p-4 text-center">
                                    <div class="text-2xl font-black" id="userPoints">0</div>
                                    <div class="text-xs text-gray-600">Points Earned</div>
                                </div>
                            </div>

                            <!-- Donation History -->
                            <div>
                                <h3 class="font-bold mb-3">Your Donations</h3>
                                <div id="donationHistory" class="space-y-3">
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-heart text-3xl mb-2"></i>
                                        <p class="text-sm">No donations yet</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>

                <!-- Floating Action Button -->
                <button id="fab" class="fab">
                    <i class="fas fa-heart"></i>
                </button>
            </div>

            <!-- Donation Bottom Sheet -->
            <div id="donationSheet" class="bottom-sheet">
                <div class="sheet-content p-6">
                    <!-- Sheet Handle -->
                    <div class="sheet-handle w-12 h-1 bg-gray-300 rounded-full mx-auto mb-6 cursor-grab"></div>
                    
                    <!-- Recipient Info -->
                    <div id="sheetRecipientInfo" class="mb-6">
                        <!-- Populated dynamically -->
                    </div>

                    <!-- Amount Selection -->
                    <div class="mb-6">
                        <h3 class="font-bold mb-3">Select Amount (ETH)</h3>
                        <div class="grid grid-cols-4 gap-2 mb-4">
                            <button class="amount-btn quick-donate-btn py-3 rounded-xl font-medium" data-amount="0.001">0.001</button>
                            <button class="amount-btn quick-donate-btn py-3 rounded-xl font-medium" data-amount="0.005">0.005</button>
                            <button class="amount-btn quick-donate-btn py-3 rounded-xl font-medium" data-amount="0.01">0.01</button>
                            <button class="amount-btn quick-donate-btn py-3 rounded-xl font-medium" data-amount="0.02">0.02</button>
                        </div>
                        <div class="relative">
                            <input type="number" id="customAmount" placeholder="Custom amount in ETH" step="0.0001" min="0.0001" class="form-input w-full px-4 py-3 rounded-xl pr-20">
                            <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-sm font-medium text-gray-600">ETH</span>
                        </div>
                        <div class="mt-2 text-center">
                        <span class="text-sm text-gray-600">≈ $<span id="usdEquivalent">0.00</span> USD</span>
                    </div>
                    <div class="mt-3 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-3">
                        <div class="text-xs font-medium text-gray-700 mb-2 text-center">🎁 Epoch 0 Rewards:</div>
                        <div class="flex justify-between text-xs">
                            <span class="text-purple-600">Points: <span id="estimatedPoints" class="font-bold">0</span></span>
                            <span class="text-blue-600">Tokens: <span id="estimatedTokens" class="font-bold">0 $GIVE</span></span>
                        </div>
                    </div>
                    </div>

                    <!-- Message -->
                    <div class="mb-6">
                        <h3 class="font-bold mb-3">Message (optional)</h3>
                        <input type="text" id="donationMessage" placeholder="Send encouragement..." class="form-input w-full px-4 py-3 rounded-xl">
                    </div>

                    <!-- Donate Button -->
                    <button id="donateBtn" class="primary-button w-full py-4 rounded-2xl text-white font-bold">
                        Send Donation
                    </button>
                </div>
            </div>

            <!-- Success Modal -->
            <div id="successModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-6">
                <div class="bg-white rounded-3xl p-6 max-w-sm w-full slide-up">
                    <div class="text-center">
                        <div class="text-6xl mb-4">🎉</div>
                        <h3 class="text-2xl font-bold mb-2">Thank You!</h3>
                        <p class="text-gray-600 mb-6">Your donation has been sent successfully.</p>
                        <div class="bg-gray-100 rounded-2xl p-4 mb-4">
                            <div class="text-sm text-gray-600 mb-1">Transaction Hash</div>
                            <div id="txHash" class="font-mono text-xs break-all">-</div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl p-4 text-center">
                                <div class="text-lg font-black text-purple-600">+<span id="pointsEarned">0</span></div>
                                <div class="text-xs text-purple-500">Points</div>
                                <div class="text-xs text-purple-400 mt-1">Epoch 0!</div>
                            </div>
                            <div class="bg-gradient-to-br from-blue-50 to-green-100 rounded-2xl p-4 text-center">
                                <div class="text-lg font-black text-blue-600">+<span id="tokensEarned">0</span></div>
                                <div class="text-xs text-blue-500">$GIVE</div>
                                <div class="text-xs text-blue-400 mt-1">Genesis!</div>
                            </div>
                        </div>
                        <button id="closeSuccessBtn" class="primary-button w-full py-3 rounded-xl text-white font-medium">
                            Done
                        </button>
                    </div>
                </div>
            </div>
        `;

        // Global variables
        let userAccount = null;
        let isConnected = false;
        let farcasterProvider = null;
        let selectedRecipient = null;
        let currentFilter = 'all';
        let currentPage = 1;
        let hasMore = true;
        let ethPrice = 2500;
        let currentTab = 'donate';
        // Epoch and Rewards System
        let currentEpoch = 0;
        let epochStartTime = Date.now();
        let epochDuration = 30 * 24 * 60 * 60 * 1000; // 30 days

        const epochMultipliers = {
            0: { points: 10.0, tokens: 5000 },
            1: { points: 8.0, tokens: 4000 },
            2: { points: 6.0, tokens: 3000 },
            3: { points: 4.0, tokens: 2000 },
            4: { points: 3.0, tokens: 1500 },
            5: { points: 2.5, tokens: 1200 },
            default: { points: 1.0, tokens: 400 }
        };

        const basePointsPerETH = 10000;
        const baseTokensPerETH = 1;

        // API Configuration
        const API_BASE = import.meta.env.DEV ? 'http://localhost:8000' : 'https://umanity.xyz';

        // Initialize app
        async function initializeApp() {
            try {
                console.log('Initializing Umanity Mini App...');

                // Load initial data
                await Promise.all([
                    loadRecipients(),
                    loadStats(),
                    fetchETHPrice()
                ]);

                // Show main content
                document.getElementById('splashScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

                // Initialize SDK
                await sdk.actions.ready();
                console.log('✅ SDK ready!');

                // Initialize wallet
                await initializeWallet();

                // Set up event listeners
                setupEventListeners();

            } catch (error) {
                console.error('Init error:', error);
                // Still show app
                document.getElementById('splashScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
            }
        }

        // Initialize wallet
        async function initializeWallet() {
            try {
                farcasterProvider = await sdk.wallet.getEthereumProvider();
                console.log('✅ Wallet provider obtained');

                // Check if already connected
                const accounts = await farcasterProvider.request({
                    method: 'eth_accounts'
                });

                if (accounts && accounts.length > 0) {
                    userAccount = accounts[0];
                    isConnected = true;
                    updateWalletUI();
                    loadUserProfile();
                }

                // Listen for account changes
                farcasterProvider.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        userAccount = accounts[0];
                        isConnected = true;
                        updateWalletUI();
                        loadUserProfile();
                    } else {
                        userAccount = null;
                        isConnected = false;
                        updateWalletUI();
                    }
                });

            } catch (error) {
                console.error('Wallet init error:', error);
            }
        }

        // Connect wallet
        async function connectWallet() {
            if (!farcasterProvider) {
                alert('Wallet not available');
                return;
            }

            try {
                const accounts = await farcasterProvider.request({
                    method: 'eth_requestAccounts'
                });

                if (accounts && accounts.length > 0) {
                    userAccount = accounts[0];
                    isConnected = true;
                    updateWalletUI();
                    loadUserProfile();
                }
            } catch (error) {
                console.error('Connect error:', error);
                alert('Failed to connect wallet');
            }
        }

        // Update wallet UI
        function updateWalletUI() {
            const walletBtn = document.getElementById('walletButton');
            if (isConnected && userAccount) {
                const shortAddr = userAccount.substring(0, 6) + '...' + userAccount.substring(38);
                walletBtn.innerHTML = '<i class="fas fa-check-circle"></i><span>' + shortAddr + '</span>';
                walletBtn.classList.add('bg-black', 'text-white');
                walletBtn.classList.remove('secondary-button');

                // Update profile avatar
                document.getElementById('profileAvatar').textContent = userAccount.substring(2, 4).toUpperCase();
                document.getElementById('profileName').textContent = shortAddr;
                document.getElementById('profileAddress').textContent = userAccount;
            } else {
                walletBtn.innerHTML = '<i class="fas fa-wallet"></i><span>Connect</span>';
                walletBtn.classList.remove('bg-black', 'text-white');
                walletBtn.classList.add('secondary-button');
            }
        }

        // Load recipients
        async function loadRecipients(page = 1, filter = 'all', append = false) {
            try {
                const url = `${API_BASE}/api/farcaster-recipients/?page=${page}&limit=10&category=${filter}`;
                const response = await fetch(url);
                const data = await response.json();

                const container = document.getElementById('recipientsList');
                if (!append) {
                    container.innerHTML = '';
                }

                if (data.recipients.length === 0 && !append) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">💙</div>
                            <h3 class="text-lg font-bold mb-2">No one needs help right now</h3>
                            <p class="text-sm text-gray-600">Check back later!</p>
                        </div>
                    `;
                    return;
                }

                data.recipients.forEach(recipient => {
                    const progress = Math.min((recipient.raised_amount / recipient.goal_amount) * 100, 100);
                    const card = createRecipientCard(recipient, progress);
                    container.appendChild(card);
                });

                // Update load more button
                hasMore = data.pagination.has_next;
                document.getElementById('loadMoreContainer').classList.toggle('hidden', !hasMore);

            } catch (error) {
                console.error('Load recipients error:', error);
                if (!append) {
                    document.getElementById('recipientsList').innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-4xl mb-4">⚠️</div>
                            <h3 class="text-lg font-bold mb-2">Unable to load</h3>
                            <p class="text-sm text-gray-600 mb-4">Check your connection</p>
                            <button onclick="loadRecipients()" class="primary-button px-6 py-2 rounded-xl text-white text-sm">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Create recipient card
        function createRecipientCard(recipient, progress) {
            const card = document.createElement('div');
            card.className = 'help-card rounded-3xl p-4 cursor-pointer';
            card.onclick = () => openDonationSheet(recipient);

            card.innerHTML = `
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-gradient-to-r from-black to-gray-700 rounded-2xl flex items-center justify-center text-white font-bold">
                            ${recipient.name.charAt(0).toUpperCase()}
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <h3 class="font-bold text-black">${recipient.name}</h3>
                                <span class="inline-flex items-center px-2 py-1 bg-gray-100 rounded-full text-xs font-medium">
                                    ${getCategoryEmoji(recipient.category)} ${recipient.category}
                                </span>
                            </div>
                            <div class="text-right ml-2">
                                <div class="font-black text-black">${recipient.raised_amount.toLocaleString()}</div>
                                <div class="text-xs text-gray-600">of ${recipient.goal_amount.toLocaleString()}</div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-700 mb-3 line-clamp-2">${recipient.description}</p>
                        <div class="mb-2">
                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                <span>${progress.toFixed(1)}% funded</span>
                                <span>${recipient.donor_count || 0} donors</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="progress-bar h-2 rounded-full" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        // Load pools
        async function loadPools() {
            try {
                const response = await fetch(`${API_BASE}/api/donation-pools/`);
                const data = await response.json();

                const container = document.getElementById('poolsList');
                container.innerHTML = '';

                data.pools.forEach(pool => {
                    const card = createPoolCard(pool);
                    container.appendChild(card);
                });

            } catch (error) {
                console.error('Load pools error:', error);
                document.getElementById('poolsList').innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-600">Unable to load pools</p>
                    </div>
                `;
            }
        }

        // Create pool card
        function createPoolCard(pool) {
            const card = document.createElement('div');
            card.className = 'help-card rounded-3xl p-5 cursor-pointer';
            card.onclick = () => openDonationSheet(pool, true);

            card.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="text-3xl">${pool.emoji}</div>
                        <div>
                            <h3 class="font-bold text-lg">${pool.name}</h3>
                            <p class="text-sm text-gray-600">${pool.donor_count} donors</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-black">${parseFloat(pool.total_raised).toLocaleString()}</div>
                        <div class="text-xs text-gray-600">raised</div>
                    </div>
                </div>
                <p class="text-sm text-gray-700 mb-3">${pool.description}</p>
                <div class="flex items-center justify-between">
                    <span class="text-xs bg-gray-100 px-3 py-1 rounded-full font-medium">
                        ${pool.allocation_percentage}% allocation
                    </span>
                    <i class="fas fa-arrow-right text-gray-400"></i>
                </div>
            `;

            return card;
        }

        // Load social feed
        async function loadSocialFeed() {
            try {
                const response = await fetch(`${API_BASE}/api/social-feed/?limit=20`);
                const data = await response.json();

                const container = document.getElementById('socialFeed');
                container.innerHTML = '';

                if (data.feed.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-stream text-3xl mb-2"></i>
                            <p class="text-sm">No recent activity</p>
                        </div>
                    `;
                    return;
                }

                data.feed.forEach(donation => {
                    const item = createFeedItem(donation);
                    container.appendChild(item);
                });

            } catch (error) {
                console.error('Load feed error:', error);
            }
        }

        // Create feed item
        function createFeedItem(donation) {
            const item = document.createElement('div');
            item.className = 'help-card rounded-2xl p-3';

            const donorName = donation.donor.display_name ||
                `${donation.donor.address.substring(0, 6)}...${donation.donor.address.substring(38)}`;
            const recipientName = donation.recipient.display_name ||
                donation.recipient.username ||
                `${donation.recipient.address.substring(0, 6)}...${donation.recipient.address.substring(38)}`;

            item.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center text-sm font-bold">
                            ${donorName.charAt(0).toUpperCase()}
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm">
                            <span class="font-semibold">${donorName}</span>
                            sent <span class="font-bold">${donation.amount}</span> to
                            <span class="font-semibold">${recipientName}</span>
                        </p>
                        ${donation.message ? `<p class="text-xs text-gray-600 mt-1">"${donation.message}"</p>` : ''}
                        <p class="text-xs text-gray-500 mt-1">${donation.time_ago}</p>
                    </div>
                    ${donation.frame_interaction ? '<span class="text-xs bg-black text-white px-2 py-1 rounded-full">Frame</span>' : ''}
                </div>
            `;

            return item;
        }

        // Load user profile
        async function loadUserProfile() {
            if (!userAccount) return;

            try {
                // Load user stats
                const statsResponse = await fetch(`${API_BASE}/api/stats/?user=${userAccount}`);
                const statsData = await statsResponse.json();

                if (statsData.user_stats) {
                    document.getElementById('userDonated').textContent = `${parseFloat(statsData.user_stats.total_donated).toLocaleString()}`;
                    document.getElementById('userPoints').textContent = statsData.user_stats.total_points.toLocaleString();
                    document.getElementById('socialRank').textContent = statsData.user_stats.rank ? `#${statsData.user_stats.rank}` : '#-';
                }
                // Update rewards display in donate tab
                if (isConnected && statsData.user_stats) {
                    document.getElementById('userRewardsCard').classList.remove('hidden');
                    document.getElementById('userPointsDisplay').textContent = formatLargeNumber(statsData.user_stats.total_points);
                    document.getElementById('userTokensDisplay').textContent = formatLargeNumber(statsData.user_stats.tokens_earned || 0) + ' $GIVE';
                }

                // Load donation history
                const historyResponse = await fetch(`${API_BASE}/api/user-donations/?user=${userAccount}`);
                const historyData = await historyResponse.json();

                const container = document.getElementById('donationHistory');
                container.innerHTML = '';

                if (historyData.donations.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-heart text-3xl mb-2"></i>
                            <p class="text-sm">No donations yet</p>
                        </div>
                    `;
                } else {
                    historyData.donations.forEach(donation => {
                        const item = createHistoryItem(donation);
                        container.appendChild(item);
                    });
                }

                // Update social stats
                document.getElementById('socialDonations').textContent = statsData.user_stats?.donation_count || 0;
                document.getElementById('socialImpact').textContent = `${parseFloat(statsData.user_stats?.total_donated || 0).toLocaleString()}`;

            } catch (error) {
                console.error('Load profile error:', error);
            }
        }

        // Load leaderboard
        async function loadLeaderboard() {
            try {
                const url = userAccount ? `${API_BASE}/api/leaderboard/?user=${userAccount}` : `${API_BASE}/api/leaderboard/`;
                const response = await fetch(url);
                const data = await response.json();

                const container = document.getElementById('leaderboardList');
                container.innerHTML = '';

                if (data.leaderboard.length === 0) {
                    container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-trophy text-3xl mb-2"></i>
                    <p class="text-sm">No donors yet</p>
                </div>
            `;
                    return;
                }

                data.leaderboard.forEach((donor, index) => {
                    const item = createLeaderboardItem(donor, index);
                    container.appendChild(item);
                });

                // Show user position if not in top 10
                if (userAccount && data.user_position && !data.user_position.is_current_user) {
                    const userPos = data.user_position;
                    document.getElementById('userPositionCard').classList.remove('hidden');
                    document.getElementById('userPositionInfo').innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="text-lg font-black text-gray-600">#${userPos.rank}</span>
                    <div class="w-8 h-8 bg-gradient-to-r from-black to-gray-700 rounded-full flex items-center justify-center text-white text-xs font-bold">
                        ${userPos.display_name ? userPos.display_name.charAt(0).toUpperCase() : 'Y'}
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">${userPos.display_name || 'You'}</p>
                        <p class="text-xs text-gray-600">${userPos.donation_count} donations</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-bold text-sm">${formatLargeNumber(userPos.total_points)} pts</p>
                    <p class="text-xs text-gray-600">${parseFloat(userPos.total_donated).toFixed(4)} ETH</p>
                </div>
            `;
                }

            } catch (error) {
                console.error('Load leaderboard error:', error);
            }
        }

        // Create leaderboard item
        function createLeaderboardItem(donor, index) {
            const item = document.createElement('div');
            const rankColors = ['text-yellow-500', 'text-gray-500', 'text-orange-500', 'text-black'];
            const rankColor = rankColors[Math.min(index, 3)];

            item.className = `help-card rounded-2xl p-4 ${donor.is_current_user ? 'bg-gradient-to-r from-purple-50 to-blue-50' : ''}`;

            item.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <span class="text-xl font-black ${rankColor}">#${donor.rank}</span>
                <div class="w-10 h-10 bg-gradient-to-r from-black to-gray-700 rounded-full flex items-center justify-center text-white text-sm font-bold">
                    ${donor.display_name ? donor.display_name.charAt(0).toUpperCase() : 'A'}
                </div>
                <div>
                    <p class="font-semibold text-sm ${donor.is_current_user ? 'text-purple-700' : 'text-black'}">${donor.display_name || donor.ens_name || (donor.address.substring(0, 6) + '...')}</p>
                    <p class="text-xs text-gray-600">${donor.donation_count} donations</p>
                </div>
                ${donor.is_current_user ? '<span class="bg-purple-500 text-white text-xs px-2 py-1 rounded-full font-medium">You</span>' : ''}
            </div>
            <div class="text-right">
                <p class="font-bold text-sm ${donor.is_current_user ? 'text-purple-600' : rankColor}">${formatLargeNumber(donor.total_points)} pts</p>
                <p class="text-xs text-gray-600">${parseFloat(donor.total_donated).toFixed(4)} ETH</p>
            </div>
        </div>
    `;

            return item;
        }
        // Create history item
        function createHistoryItem(donation) {
            const item = document.createElement('div');
            item.className = 'help-card rounded-2xl p-3';

            item.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">${donation.emoji}</div>
                        <div>
                            <p class="font-semibold text-sm">${donation.recipient_name}</p>
                            <p class="text-xs text-gray-600">${donation.time_ago}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold">${donation.amount}</p>
                        <p class="text-xs text-gray-600">+${donation.points_earned} pts</p>
                    </div>
                </div>
            `;

            return item;
        }

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/api/farcaster-stats/`);
                const data = await response.json();

                document.getElementById('totalRaised').textContent = `${data.total_raised.toLocaleString()}`;
                document.getElementById('peopleHelped').textContent = data.active_recipients.toLocaleString();

            } catch (error) {
                console.error('Load stats error:', error);
            }
        }

        // Fetch ETH price
        async function fetchETHPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd');
                const data = await response.json();
                ethPrice = data.ethereum.usd;
            } catch (error) {
                console.error('ETH price error:', error);
            }
        }

        // Epoch calculation functions
        function getCurrentEpoch() {
            const timeElapsed = Date.now() - epochStartTime;
            return Math.floor(timeElapsed / epochDuration);
        }

        function getEpochMultipliers(epoch = null) {
            const targetEpoch = epoch !== null ? epoch : getCurrentEpoch();
            return epochMultipliers[targetEpoch] || epochMultipliers.default;
        }

        function calculateRewards(ethAmount, isPublic = false) {
            const epoch = getCurrentEpoch();
            const multipliers = getEpochMultipliers(epoch);

            const basePoints = Math.floor(ethAmount * basePointsPerETH);
            const baseTokens = ethAmount * baseTokensPerETH;

            const epochPoints = Math.floor(basePoints * multipliers.points);
            const epochTokens = baseTokens * multipliers.tokens;

            const finalPoints = isPublic ? Math.floor(epochPoints * 1.2) : epochPoints;
            const finalTokens = isPublic ? epochTokens * 1.2 : epochTokens;

            return {
                points: finalPoints,
                tokens: finalTokens,
                epoch: epoch,
                multipliers: multipliers
            };
        }

        function formatLargeNumber(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return Math.floor(num).toString();
        }

        // Open donation sheet
        function openDonationSheet(recipient, isPool = false) {
            if (!isConnected) {
                alert('Please connect your wallet first!');
                return;
            }

            selectedRecipient = recipient;

            const info = document.getElementById('sheetRecipientInfo');
            info.innerHTML = `
                <div class="flex items-center space-x-3 mb-4">
                    <div class="text-3xl">${isPool ? recipient.emoji : getCategoryEmoji(recipient.category)}</div>
                    <div>
                        <h3 class="font-bold text-lg">${recipient.name}</h3>
                        <p class="text-sm text-gray-600">${recipient.category}</p>
                    </div>
                </div>
                <p class="text-sm text-gray-700">${recipient.description}</p>
            `;

            // Reset form
            document.querySelectorAll('.amount-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('customAmount').value = '';
            document.getElementById('donationMessage').value = '';
            document.getElementById('usdEquivalent').textContent = '0.00';

            const sheet = document.getElementById('donationSheet');
            sheet.style.transform = '';
            sheet.classList.add('open');
        }

        // Close donation sheet
        function closeDonationSheet() {
            const sheet = document.getElementById('donationSheet');
            sheet.classList.remove('open');
            sheet.style.transform = '';
            selectedRecipient = null;
            // Reset USD display
            document.getElementById('usdEquivalent').textContent = '0.00';
        }

        // Process donation
        async function processDonation() {
            if (!selectedRecipient || !farcasterProvider) return;

            // Get amount in ETH
            const customAmount = parseFloat(document.getElementById('customAmount').value) || 0;
            const selectedBtn = document.querySelector('.amount-btn.selected');
            const presetAmount = selectedBtn ? parseFloat(selectedBtn.dataset.amount) : 0;
            const ethAmount = Math.max(customAmount, presetAmount);

            if (ethAmount < 0.0001) {
                alert('Minimum donation is 0.0001 ETH');
                return;
            }

            const usdAmount = ethAmount * ethPrice;
            const message = document.getElementById('donationMessage').value;

            const donateBtn = document.getElementById('donateBtn');
            donateBtn.textContent = 'Processing...';
            donateBtn.disabled = true;

            try {
                // Send transaction
                const weiAmount = '0x' + Math.floor(ethAmount * 1e18).toString(16);

                const txHash = await farcasterProvider.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAccount,
                        to: selectedRecipient.wallet_address,
                        value: weiAmount,
                        gas: '0x5208',
                    }]
                });

                // Record donation
                await fetch(`${API_BASE}/api/record-farcaster-donation/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        donor_address: userAccount,
                        recipient_id: selectedRecipient.id,
                        amount_usd: usdAmount,
                        amount_eth: ethAmount,
                        message: message,
                        tx_hash: txHash,
                        platform: 'farcaster'
                    }),
                });

                // Calculate and show rewards
                const rewards = calculateRewards(ethAmount, false);
                document.getElementById('txHash').textContent = txHash;
                document.getElementById('pointsEarned').textContent = formatLargeNumber(rewards.points);
                document.getElementById('tokensEarned').textContent = formatLargeNumber(rewards.tokens);

                closeDonationSheet();
                document.getElementById('successModal').classList.remove('hidden');

                // Refresh data
                loadStats();
                loadRecipients(1, currentFilter);
                loadUserProfile();

            } catch (error) {
                console.error('Donation error:', error);
                alert(error.code === 4001 ? 'Transaction cancelled' : 'Transaction failed');
            } finally {
                donateBtn.textContent = 'Send Donation';
                donateBtn.disabled = false;
            }
        }

        // Quick send
        async function quickSend() {
            const recipient = document.getElementById('recipientUsername').value;
            if (!recipient) {
                alert('Please enter a username or address');
                return;
            }

            // Open donation sheet for P2P
            openDonationSheet({
                id: 'p2p',
                name: recipient,
                category: 'user',
                description: 'Direct peer-to-peer donation',
                wallet_address: recipient.startsWith('0x') ? recipient : null,
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Wallet button
            document.getElementById('walletButton').addEventListener('click', connectWallet);

            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tab = e.target.dataset.tab;
                    switchTab(tab);
                });
            });

            // Filter pills
            document.querySelectorAll('.filter-pill').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filter = e.target.dataset.filter;
                    currentFilter = filter;
                    currentPage = 1;

                    // Update UI
                    document.querySelectorAll('.filter-pill').forEach(p => {
                        p.classList.remove('bg-black', 'text-white');
                        p.classList.add('bg-gray-100', 'text-gray-700');
                    });
                    e.target.classList.add('bg-black', 'text-white');
                    e.target.classList.remove('bg-gray-100', 'text-gray-700');

                    loadRecipients(1, filter);
                });
            });

            // Load more
            document.getElementById('loadMoreBtn').addEventListener('click', () => {
                currentPage++;
                loadRecipients(currentPage, currentFilter, true);
            });

            // Amount buttons
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
                    e.target.classList.add('selected');
                    document.getElementById('customAmount').value = '';
                    const amount = parseFloat(e.target.dataset.amount);
                    updateUSDEquivalent(amount);
                    updateRewardsPreview(amount);
                });
            });

            // Custom amount with USD conversion
            document.getElementById('customAmount').addEventListener('input', (e) => {
                document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
                const ethValue = parseFloat(e.target.value) || 0;
                updateUSDEquivalent(ethValue);
                updateRewardsPreview(ethValue);
            });

            // Donate button
            document.getElementById('donateBtn').addEventListener('click', processDonation);

            // Quick send
            document.getElementById('quickSendBtn').addEventListener('click', quickSend);

            // Close success modal
            document.getElementById('closeSuccessBtn').addEventListener('click', () => {
                document.getElementById('successModal').classList.add('hidden');
            });

            // FAB
            document.getElementById('fab').addEventListener('click', () => {
                if (currentTab === 'donate' && selectedRecipient) {
                    openDonationSheet(selectedRecipient);
                } else {
                    switchTab('donate');
                }
            });

            // Bottom sheet swipe to close
            let sheetStartY = 0;
            let sheetCurrentY = 0;
            let isDragging = false;
            const sheet = document.getElementById('donationSheet');
            const sheetContent = sheet.querySelector('.sheet-content');
            const sheetHandle = sheet.querySelector('.sheet-handle');

            // Handle drag start
            const handleDragStart = (e) => {
                isDragging = true;
                sheetStartY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                sheet.style.transition = 'none';
            };

            // Handle drag move
            const handleDragMove = (e) => {
                if (!isDragging) return;

                sheetCurrentY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                const translateY = Math.max(0, sheetCurrentY - sheetStartY);

                sheet.style.transform = `translateY(${translateY}px)`;
            };

            // Handle drag end
            const handleDragEnd = (e) => {
                if (!isDragging) return;
                isDragging = false;

                const translateY = sheetCurrentY - sheetStartY;
                sheet.style.transition = '';

                // If dragged more than 100px or 25% of sheet height, close it
                if (translateY > 100 || translateY > sheet.offsetHeight * 0.25) {
                    closeDonationSheet();
                } else {
                    sheet.style.transform = '';
                }
            };

            // Touch events for sheet handle
            sheetHandle.addEventListener('touchstart', handleDragStart, { passive: true });
            document.addEventListener('touchmove', handleDragMove, { passive: true });
            document.addEventListener('touchend', handleDragEnd);

            // Mouse events for sheet handle (desktop testing)
            sheetHandle.addEventListener('mousedown', handleDragStart);
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleDragEnd);

            // Click outside to close
            sheet.addEventListener('click', (e) => {
                if (e.target === sheet) {
                    closeDonationSheet();
                }
            });

            // Pull to refresh
            let startY = 0;
            let isPulling = false;

            document.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0 && !sheet.classList.contains('open')) {
                    startY = e.touches[0].clientY;
                    isPulling = true;
                }
            });

            document.addEventListener('touchmove', (e) => {
                if (!isPulling) return;

                const currentY = e.touches[0].clientY;
                const diff = currentY - startY;

                if (diff > 50) {
                    document.getElementById('pullToRefresh').classList.add('active');
                }
            });

            document.addEventListener('touchend', () => {
                if (document.getElementById('pullToRefresh').classList.contains('active')) {
                    refreshCurrentTab();
                }
                document.getElementById('pullToRefresh').classList.remove('active');
                isPulling = false;
            });
        }

        // Update USD equivalent display
        function updateUSDEquivalent(ethAmount) {
            const usdAmount = ethAmount * ethPrice;
            document.getElementById('usdEquivalent').textContent = usdAmount.toFixed(2);
        }

        // Update rewards preview
        function updateRewardsPreview(ethAmount) {
            const rewards = calculateRewards(ethAmount, false);
            document.getElementById('estimatedPoints').textContent = formatLargeNumber(rewards.points);
            document.getElementById('estimatedTokens').textContent = formatLargeNumber(rewards.tokens);
        }

        // Switch tab
        function switchTab(tab) {
            currentTab = tab;

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.classList.add('active');
                    btn.classList.remove('text-gray-500');
                } else {
                    btn.classList.remove('active');
                    btn.classList.add('text-gray-500');
                }
            });

            // Update tab indicator
            const activeBtn = document.querySelector('.tab-btn.active');
            const indicator = document.getElementById('tabIndicator');
            if (activeBtn) {
                indicator.style.left = activeBtn.offsetLeft + 'px';
                indicator.style.width = activeBtn.offsetWidth + 'px';
            }

            // Show/hide content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tab + 'Tab').classList.remove('hidden');

            // Load tab data
            if (tab === 'pools') {
                loadPools();
            } else if (tab === 'social') {
                loadSocialFeed();
            } else if (tab === 'leaderboard') {
                loadLeaderboard();
            } else if (tab === 'profile') {
                loadUserProfile();
            }
        }

        function refreshCurrentTab() {
            if (currentTab === 'donate') {
                loadRecipients(1, currentFilter);
                loadStats();
            } else if (currentTab === 'pools') {
                loadPools();
            } else if (currentTab === 'social') {
                loadSocialFeed();
            } else if (currentTab === 'leaderboard') {
                loadLeaderboard();
            } else if (currentTab === 'profile') {
                loadUserProfile();
            }
        }

        // Helper functions
        function getCategoryEmoji(category) {
            const emojis = {
                'medical': '🏥',
                'emergency': '🚨',
                'education': '🎓',
                'community': '🏘️',
                'user': '👤',
                'other': '💝'
            };
            return emojis[category] || '💝';
        }

        // Initialize app on load
        window.addEventListener('load', initializeApp);
    </script>
</body>

</html>